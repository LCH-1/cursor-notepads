name: Publish Extension

on:
  release:

jobs:
  publish:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - run: npm ci
      - run: npm run build --if-present

      - name: Verify tag equals package.json version
        run: |
          TAG="${GITHUB_REF#refs/tags/}"
          PKG_VER="$(node -p "require('./package.json').version")"
          [[ "$TAG" == "v$PKG_VER" ]] || { echo "Tag $TAG != package.json $PKG_VER"; exit 1; }

      - name: Publish to Open VSX
        id: ovsx
        uses: HaaLeo/publish-vscode-extension@v2
        with:
          pat: ${{ secrets.OPEN_VSX_TOKEN }}
          preRelease: ${{ github.event.release.prerelease }}
          skipDuplicate: true
